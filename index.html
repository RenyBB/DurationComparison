<!DOCTYPE html>
<html>
<head>
    <title>Duration comparison</title>
    <script src="https://unpkg.com/jspsych@7.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.0.0"></script>
    <script src="DurationComparison/StimulusConditionCombinations.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.0.0/css/jspsych.css">
</head>
<body>
    <style>
    </style>
</body>
<script>

// Task description
/* Participants will hear pairs of sounds and have to say which sound (1st or 2nd) is higher in pitch.
   The task consists of training phase (2 trials) and test phase (30 trials).
   In the training phase participants receive feedback whether their response was correct or incorrect.
   There is no feedback in the test phase. On some trials in the test phase participants are also asked an additional subjective rating question. 
   There are 4 different subejctive question. Each is repeated twice. 
*/

// NOTE: the stimuli are located in Stimuli/PitchDiscrimination
// There are 2 js files in that are used to load the stimuli: PitchDiscrimination_TestStimuli and PitchDiscrimination_TrainingStimuli

// TO DO
/*
(1) Feedback at the end of the task: this corresponds to the number of correct responses in the test phase. I have added the code to count the number of correct responses at the end, but it doesn't work.
(2) The raw data is a bit hideous, I have to tidy it up. 
*/

  // initialize jsPsych
  // NB: remove data display from final version! */
  var jsPsych = initJsPsych({
    use_webaudio: false,
    show_progress_bar: true,
    auto_update_progress_bar: false,
    on_finish: function () {
       jsPsych.data.displayData();
    }
  });


var timeline = [];



all_durations = [1500, 2000, 2500, 3000, 3500, 4000]
all_sampling_rates = [2, 4]

all_durations_shuffled = jsPsych.randomization.shuffle(all_durations)
selected_sampling_rate = jsPsych.randomization.sampleWithReplacement(all_sampling_rates, 1)[0]
for (i=0; i<stimuli_combinations.length; i ++) {stimuli_combinations[i].duration = all_durations_shuffled[stimuli_combinations[i].pairing_id-1]; stimuli_combinations[i].sampling_rate = selected_sampling_rate;  }

var stimulus_path = "DurationComparison/"


for (i=0; i<stimuli_combinations.length; i ++) {
    if (stimuli_combinations[i].first_interval == "iso" || stimuli_combinations[i].first_interval == "anis")
            {stimuli_combinations[i].first_interval_filename = stimulus_path.concat(stimuli_combinations[i].first_interval).concat("_").concat(stimuli_combinations[i].duration).concat("ms_").concat(stimuli_combinations[i].sampling_rate).concat("Hz.wav")}
    else if (stimuli_combinations[i].first_interval == "continuous" || stimuli_combinations[i].first_interval == "empty")
            {stimuli_combinations[i].first_interval_filename = stimulus_path.concat(stimuli_combinations[i].first_interval).concat("_").concat(stimuli_combinations[i].duration).concat("ms").concat(".wav")}  
   if (stimuli_combinations[i].second_interval == "iso" || stimuli_combinations[i].second_interval == "anis")
            {stimuli_combinations[i].second_interval_filename = stimulus_path.concat(stimuli_combinations[i].second_interval).concat("_").concat(stimuli_combinations[i].duration).concat("ms_").concat(stimuli_combinations[i].sampling_rate).concat("Hz.wav")}
    else if (stimuli_combinations[i].second_interval == "continuous" || stimuli_combinations[i].second_interval == "empty")
            {stimuli_combinations[i].second_interval_filename = stimulus_path.concat(stimuli_combinations[i].second_interval).concat("_").concat(stimuli_combinations[i].duration).concat("ms").concat(".wav")}  
}



// Define number of repetitions per stimulus and total number of trials
var n_reps_per_stim = 1;
var n_trials_types = stimuli_combinations.length ;
var n_trials = n_reps_per_stim*n_trials_types;

  // Collect system information
  var setup_info = {
    type: jsPsychBrowserCheck
  };
  timeline.push(setup_info);


 //welcome message
    var welcome_message = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p>This task contains audio clips. </p>
    <p>  Please make sure you are in a quiet and relaxed environment and have a pair of headphones or speakers.</p>
    <p>  You will now hear a tone so that you can adjust the volume of the audio to a comfortable level.<br>Set the volume low in case it is too loud!</p>`,
    choices: ['Continue']
    };
  timeline.push(welcome_message); 


  /* Preload stimuli
      var preload = {
          type: jsPsychPreload,
          audio: [],
      };
  timeline.push(preload);*/

  // Adjust volume
  var adjust_volume = {
    type: jsPsychAudioButtonResponse,
    stimulus: 'VolumeAdjustmentStim.mp3',
    prompt: 'Adjust the volume to a comfortable level.',
    choices: ['Continue'],
    response_ends_trial: true
};
timeline.push(adjust_volume);

  /* Preload stimuli
      var preload = {
          type: jsPsychPreload,
          audio: [],
      };
  timeline.push(preload);*/



// Test phase instructions
   var testInstructions = {
          type: jsPsychInstructions,
          pages: [`<p> In tis task, you will listen to two audio clips. 
         <br> The clips will consist of a constant tone or different patterns of tones, and will go for different lengths of time. 
         <br> You will need to say which of the two clips seemed longer to you.
         <br><br> We will now go through the different types of audio clips you will hear in the task. </p>`],
         allow_backward: false,
         show_clickable_nav: true,
         button_label_next: ['Continue']
    };
    timeline.push(testInstructions);

var Stim1_Prompt = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'The first type of clip consists of a constant tone.',
    choices: ['Play'],
    post_trial_gap: post_prompt_iti
};
var Stim1_Example = {
    type: jsPsychAudioButtonResponse,
    stimulus: stimulus_path.concat('continuous_1000ms.wav'),
    choices: ['Play again', 'Continue'],
    post_trial_gap: post_prompt_iti,
    response_allowed_while_playing: false
};
var Stim1_loop ={
    timeline: [Stim1_Example],
    loop_function: function (data){
        if(data.values()[0].response == 0){
            return true; 
        }   else {
            return false; 
        } 
    } 
} 


var Stim2_Prompt = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'The second type of clip has a tone signaling the start of the clip and a second tone signalling the end of the interval.<br>There is no other sound between the two tone.',
    choices: ['Play'],
    post_trial_gap: post_prompt_iti
};
var Stim2_Example = {
    type: jsPsychAudioButtonResponse,
    stimulus: stimulus_path.concat('empty_2500ms.wav'),
    choices: ['Play again', 'Continue'],
    post_trial_gap: post_prompt_iti,
    response_allowed_while_playing: false
};
var Stim2_loop ={
    timeline: [Stim2_Example],
    loop_function: function (data){
        if(data.values()[0].response == 0){
            return true; 
        }   else {
            return false; 
        } 
    } 
} 

var Stim3_Prompt = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'The third type of clip has a tone signaling the start and end of the clip.<br>There are rhythmic tones between the start and the end.',
    choices: ['Play'],
    post_trial_gap: post_prompt_iti
};
var Stim3_Example = {
    type: jsPsychAudioButtonResponse,
    stimulus: stimulus_path.concat('iso_3000ms_2Hz.wav'),
    choices: ['Play again', 'Continue'],
    post_trial_gap: post_prompt_iti,
    response_allowed_while_playing: false
};
var Stim3_loop ={
    timeline: [Stim3_Example],
    loop_function: function (data){
        if(data.values()[0].response == 0){
            return true; 
        }   else {
            return false; 
        } 
    } 
} 

var Stim4_Prompt = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'The last type of clip has a tone signaling the start and end of the interval.<br>There are arhythmic tones between the start and the end.',
    choices: ['Play'],
    post_trial_gap: post_prompt_iti
};
var Stim4_Example = {
    type: jsPsychAudioButtonResponse,
    stimulus: stimulus_path.concat('anis_3000ms_2Hz.wav'),
    choices: ['Play again', 'Continue'],
    post_trial_gap: post_prompt_iti,
    response_allowed_while_playing: false
};
var Stim4_loop ={
    timeline: [Stim4_Example],
    loop_function: function (data){
        if(data.values()[0].response == 0){
            return true; 
        }   else {
            return false; 
        } 
    } 
} 

    timeline.push(Stim1_Prompt,Stim1_loop);
    timeline.push(Stim2_Prompt,Stim2_loop);
    timeline.push(Stim3_Prompt,Stim3_loop);
    timeline.push(Stim4_Prompt,Stim4_loop);

    var post_prompt_iti = 600;



// Test phase instructions
var testInstructions2 = {
          type: jsPsychHtmlButtonResponse,
          stimulus: `<p> The two audio clips you will be asked to compare will have different structures. Continue for an example of the task.</p>`,
         choices: ['Continue']    
    };
    timeline.push(testInstructions2);

    // Test phase instructions
var testInstructions3 = {
          type: jsPsychIntructions,
          pages: [`<p> You are now ready for the main task.<br>Please do not try use any counting strategies to complete the task. All audio clips are very short and counting will be detrimental.<br>Just pay attention to how long the audio clips last.</p>`],
          button_label_next: ['Continue'],
          show_clickable_nav: true,
          allow_backward: false,
          on_start: function () {
            // set progress bar to 0 at the start of experiment
            jsPsych.setProgressBar(0);
        }    
    };

// Define stimuli for the test phase
var Interval1_Prompt = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Next pair of audio clips',
    choices: ['Play Clip 1'],
    post_trial_gap: post_prompt_iti
};


var Interval1_Prompt_Training = {
    type: jsPsychHtmlButtonResponse,
    stimulus: ['You will now hear an example pair of audio clips.'],
    choices: ['Play Clip 1'],
    post_trial_gap: post_prompt_iti
};


var Interval2_Prompt = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '',
    choices: ['Play Clip 2'],
    post_trial_gap: post_prompt_iti
};



var Interval1_Training = {
    type: jsPsychAudioButtonResponse,
    stimulus: stimulus_path.concat('continuous_1000ms.wav'),
    choices: '',
    trial_ends_after_audio:true,
    post_trial_gap: post_prompt_iti
};

var Interval2_Training = {
    type: jsPsychAudioButtonResponse,
    stimulus: stimulus_path.concat('anis_3000ms_2Hz.wav'),
    choices: '',
    trial_ends_after_audio:true,
    post_trial_gap: post_prompt_iti
};


    // Pitch dicrimination question - appears in both training and testing phase
var DuractionComparison_Training = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Was the 1st or the 2nd clip longer?',
    choices: ['First clip was longer', 'Second clip was longer', 'The clips were equal'],
    on_finish: function (data) {
            data.first_stimulus = 'Stimuli/DurationComparison/continuous_1000ms.wav';
            data.second_stimulus = 'Stimuli/DurationComparison/anis_3000ms_2Hz.wav';
            if (data.response == 1) {data.correct = 1}
            else {data.correct = 0}
    }
}

var DuractionComparison_Feedback = {
    type: jsPsychHtmlButtonResponse,
    stimulus: function(){
    // The feedback stimulus is a dynamic parameter because we can't know in advance whether
    // the stimulus should be 'correct' or 'incorrect'.
    // Instead, this function will check the accuracy of the last response and use that information to set
    // the stimulus value on each trial.
    var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
    if(last_trial_correct){
      return "<p>Your response was correct!</p>"; // the parameter value has to be returned from the function
    } else {
      return "<p>Your response was not correct - the second clip was longer.</p>"; // the parameter value has to be returned from the function
    }
  },
    choices: ['Continue'],  
}


var Interval1_Stimulus = {
    type: jsPsychAudioButtonResponse,
    stimulus: jsPsych.timelineVariable('first_interval_filename'),
    choices: '',
    trial_ends_after_audio:true,
    post_trial_gap: post_prompt_iti
};

var Interval2_Stimulus = {
    type: jsPsychAudioButtonResponse,
    stimulus: jsPsych.timelineVariable('second_interval_filename'),
    choices: '',
    trial_ends_after_audio:true,
    post_trial_gap: post_prompt_iti
};


    // Pitch dicrimination question - appears in both training and testing phase
var DuractionComparison_Resp = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Was the 1st or the 2nd clip longer?',
    choices: ['First clip was longer', 'Second clip was longer', 'The clip were equal'],
    on_finish: function (data) {
            data.test = 1;
            console.log(jsPsych.data.get().select('test').values.length);

            data.first_stimulus = jsPsych.timelineVariable('first_interval_filename');
            data.second_stimulus = jsPsych.timelineVariable('second_interval_filename') ;
            var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
            jsPsych.setProgressBar(curr_progress_bar_value + (1 / n_trials));
    }

};
var FreeText = {
  type: jsPsychSurveyText,
  questions: [
    {prompt: 'Thank you for completing this task!<br>We will appreciate it if you could briefly describe what the durations of the 4 types of audio clips were like to you.<br>Did any type seem particularly different in duration to the others?'}
  ],
    button_label: ['Continue']
}

var training_procedure = {
        timeline: [Interval1_Prompt_Training,Interval1_Training,Interval2_Prompt,Interval2_Training, DuractionComparison_Training, DuractionComparison_Feedback],
    };

// Push testing
    var test_procedure = {
        timeline: [Interval1_Prompt,Interval1_Stimulus,Interval2_Prompt,Interval2_Stimulus, DuractionComparison_Resp],
        timeline_variables: stimuli_combinations,
        randomize_order: true,
        repetitions: 1//n_reps_per_stim 
    };

    timeline.push(training_procedure, testInstructions3, test_procedure, FreeText);

    
// Debrief
      var DebriefMessage = {
          type: jsPsychHtmlButtonResponse,
          stimulus: [''],
          choices: ['See your data']
      };
      timeline.push(DebriefMessage);


  // Run the experiment
  jsPsych.run(timeline);

</script>
</html>
